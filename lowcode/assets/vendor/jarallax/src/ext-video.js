import VideoWorker from"video-worker";import global from"./utils/global";function jarallaxVideo(jarallax=global.jarallax){if("undefined"===typeof jarallax){return}const Jarallax=jarallax.constructor;const defOnScroll=Jarallax.prototype.onScroll;Jarallax.prototype.onScroll=function(){const self=this;defOnScroll.apply(self);const isReady=!self.isVideoInserted&&self.video&&(!self.options.videoLazyLoading||self.isElementInViewport)&&!self.options.disableVideo();if(isReady){self.isVideoInserted=true;self.video.getVideo((video=>{const $parent=video.parentNode;self.css(video,{position:self.image.position,top:"0px",left:"0px",right:"0px",bottom:"0px",width:"100%",height:"100%",maxWidth:"none",maxHeight:"none",pointerEvents:"none",transformStyle:"preserve-3d",backfaceVisibility:"hidden",willChange:"transform,opacity",margin:0,zIndex:-1});self.$video=video;if("local"===self.video.type){if(self.image.src){self.$video.setAttribute("poster",self.image.src)}else if(self.image.$item&&"IMG"===self.image.$item.tagName&&self.image.$item.src){self.$video.setAttribute("poster",self.image.$item.src)}}self.image.$container.appendChild(video);$parent.parentNode.removeChild($parent);if(self.options.onVideoInsert){self.options.onVideoInsert.call(self)}}))}};const defCoverImage=Jarallax.prototype.coverImage;Jarallax.prototype.coverImage=function(){const self=this;const imageData=defCoverImage.apply(self);const node=self.image.$item?self.image.$item.nodeName:false;if(imageData&&self.video&&node&&("IFRAME"===node||"VIDEO"===node)){let h=imageData.image.height;let w=h*self.image.width/self.image.height;let ml=(imageData.container.width-w)/2;let mt=imageData.image.marginTop;if(imageData.container.width>w){w=imageData.container.width;h=w*self.image.height/self.image.width;ml=0;mt+=(imageData.image.height-h)/2}if("IFRAME"===node){h+=400;mt-=200}self.css(self.$video,{width:`${w}px`,marginLeft:`${ml}px`,height:`${h}px`,marginTop:`${mt}px`})}return imageData};const defInitImg=Jarallax.prototype.initImg;Jarallax.prototype.initImg=function(){const self=this;const defaultResult=defInitImg.apply(self);if(!self.options.videoSrc){self.options.videoSrc=self.$item.getAttribute("data-jarallax-video")||null}if(self.options.videoSrc){self.defaultInitImgResult=defaultResult;return true}return defaultResult};const defCanInitParallax=Jarallax.prototype.canInitParallax;Jarallax.prototype.canInitParallax=function(){const self=this;let defaultResult=defCanInitParallax.apply(self);if(!self.options.videoSrc){return defaultResult}const video=new VideoWorker(self.options.videoSrc,{autoplay:true,loop:self.options.videoLoop,showControls:false,accessibilityHidden:true,startTime:self.options.videoStartTime||0,endTime:self.options.videoEndTime||0,mute:self.options.videoVolume?0:1,volume:self.options.videoVolume||0});if(self.options.onVideoWorkerInit){self.options.onVideoWorkerInit.call(self,video)}function resetDefaultImage(){if(self.image.$default_item){self.image.$item=self.image.$default_item;self.image.$item.style.display="block";self.coverImage();self.onScroll()}}if(video.isValid()){if(this.options.disableParallax()){defaultResult=true;self.image.position="absolute";self.options.type="scroll";self.options.speed=1}if(!defaultResult){if(!self.defaultInitImgResult){video.getImageURL((url=>{const curStyle=self.$item.getAttribute("style");if(curStyle){self.$item.setAttribute("data-jarallax-original-styles",curStyle)}self.css(self.$item,{"background-image":`url("${url}")`,"background-position":"center","background-size":"cover"})}))}}else{video.on("ready",(()=>{if(self.options.videoPlayOnlyVisible){const oldOnScroll=self.onScroll;self.onScroll=function(){oldOnScroll.apply(self);if(!self.videoError&&(self.options.videoLoop||!self.options.videoLoop&&!self.videoEnded)){if(self.isVisible()){video.play()}else{video.pause()}}}}else{video.play()}}));video.on("started",(()=>{self.image.$default_item=self.image.$item;self.image.$item=self.$video;self.image.width=self.video.videoWidth||1280;self.image.height=self.video.videoHeight||720;self.coverImage();self.onScroll();if(self.image.$default_item){self.image.$default_item.style.display="none"}}));video.on("ended",(()=>{self.videoEnded=true;if(!self.options.videoLoop){resetDefaultImage()}}));video.on("error",(()=>{self.videoError=true;resetDefaultImage()}));self.video=video;if(!self.defaultInitImgResult){self.image.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";if("local"!==video.type){video.getImageURL((url=>{self.image.bgImage=`url("${url}")`;self.init()}));return false}}}}return defaultResult};const defDestroy=Jarallax.prototype.destroy;Jarallax.prototype.destroy=function(){const self=this;if(self.image.$default_item){self.image.$item=self.image.$default_item;delete self.image.$default_item}defDestroy.apply(self)}}export default jarallaxVideo;